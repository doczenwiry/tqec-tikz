\usepackage{pgfplots}
\pgfplotsset{compat=1.18}

\usepackage{ifthen}
\usepackage{xstring}

\usepackage{tikz}
\usepackage{tikz-3dplot}

\tikzstyle{border}=[darkgray!90, line width=0.25pt, rounded corners = 0.125pt]
\tikzstyle{edge}=[line cap = round, ultra thick]
\tikzstyle{identity}=[darkgray!90]
\tikzstyle{hadamard}=[yellow!75!black!75]

\tikzstyle{axis}=[line cap=round, thick]
\tikzstyle{U}=[lightgray]
\tikzstyle{X}=[  red!75!black!50]
\tikzstyle{Y}=[green!75!black!50]
\tikzstyle{Z}=[ blue!75!black!50]
\tikzstyle{O}=[darkgray!90, line width = 1pt]

\tikzset{
	% Graph parameters
	zx/graph/style/.store in=\GraphNodeStyle, % global style for all nodes; spider or cube
	zx/graph/labels/.initial=hide,
	zx/graph/labels/.store in=\ShowNodeLabels,
	zx/graph/rotationX/.store in=\RotationX,
	zx/graph/rotationZ/.store in=\RotationZ,
	% Node parameters
	zx/node/kind/.store in=\NodeKind, % XZZ, ZXZ, ZZX, ZXX, XZX or XXZ
	zx/node/type/.initial=X,
	zx/node/type/.store in=\NodeType, % corresponds red and blue spiders; X, Z or O (boundary)
	zx/node/plane/.store in=\NodePlane, % plane in which the legs lie; X, Y or Z
	zx/node/style/.store in=\NodeStyle, % specific style for this node; spider or cube
	zx/node/labels/.store in=\ShowNodeLabels, % whether to display the identifier on the node
	zx/node/identifier/.store in=\Identifier, % used to connect edges
	% Edge parameters
	zx/edge/axis/.store in=\EdgeAxis, % Edge represents change of +1/-1 between two adjacent nodes along an axis
	zx/edge/type/.store in=\EdgeType, % identity or hadamard
}

\newcommand{\Node}[2][]{
	\begingroup
		\tikzset{zx/node/.cd, #1}

		% Set empty identifier if none provided
		\ifdefined\Identifier\else
			\def\Identifier{}
		\fi

		% Use global node style if no specific node style provided
		\ifdefined\NodeStyle\else
			\def\NodeStyle{\GraphNodeStyle}
		\fi

		% Prepare the coordinate of the center of the node
		\coordinate (node\Identifier) at #2;
		\node (\Identifier) at (node\Identifier) {};

		% Derive node kind from type/plane and vice-versa
		% TODO: warning when kind and type/plane are both provided
		% TODO: error when kind and type/plane are conflicting specifications
		\ifdefined\NodeKind
			\IfStrEqCase{\NodeKind}{
				{XXX}{\def\NodeType{X}\def\NodePlane{U}}
				{ZZZ}{\def\NodeType{Z}\def\NodePlane{U}}
				{XZZ}{\def\NodeType{X}\def\NodePlane{X}}
				{ZXZ}{\def\NodeType{X}\def\NodePlane{Y}}
				{ZZX}{\def\NodeType{X}\def\NodePlane{Z}}
				{ZXX}{\def\NodeType{Z}\def\NodePlane{X}}
				{XZX}{\def\NodeType{Z}\def\NodePlane{Y}}
				{XXZ}{\def\NodeType{Z}\def\NodePlane{Z}}
				{OOO}{\def\NodeType{O}}
				{XYZ}{}
			}
		\else
			\IfStrEqCase{\NodeType}{
				{X}{
					\ifdefined\NodePlane
						\IfStrEqCase{\NodePlane}{
							{X}{\def\NodeKind{XZZ}}
							{Y}{\def\NodeKind{ZXZ}}
							{Z}{\def\NodeKind{ZZX}}
							{U}{\def\NodeKind{XXX}}
						}
					\else
						\def\NodeKind{XXX}
					\fi
				}
				{Z}{
					\ifdefined\NodePlane
						\IfStrEqCase{\NodePlane}{
							{X}{\def\NodeKind{ZXX}}
							{Y}{\def\NodeKind{XZX}}
							{Z}{\def\NodeKind{XXZ}}
							{U}{\def\NodeKind{ZZZ}}
						}
					\else
						\def\NodeKind{ZZZ}
					\fi
				}
				{O}{
					\def\NodeKind{OOO}
				}
			}
		\fi

		\IfStrEqCase{\NodeStyle}{
			{spider}{
				% Draw spider disk
				\ifthenelse{\equal{\NodeType}{O}}{
					\fill[\NodeType] (node\Identifier) circle (2pt);
				}{
					\fill[\NodeType] (node\Identifier) circle (3pt);
				}
			
				% Place label on spider
				\ifdefined\ShowNodeLabels
					\IfStrEqCase{\ShowNodeLabels}{
						{show}{\node[white, scale=0.25] at (node\Identifier) {\tt\Identifier};}
						{hide}{}
					}
				\fi
			
				% Draw spider plane constraint
				\ifdefined\NodePlane
					\draw[\NodePlane, line width = 1pt] (node\Identifier) circle (4pt);
				\fi
			}
			{cube}{
				\def\CubeOpacity{1.0}
				\IfStrEqCase{\NodeKind}{
					{XXX}{\def\ColorX{X}\def\ColorY{X}\def\ColorZ{X}\def\CubeOpacity{0.4}}
					{ZZZ}{\def\ColorX{Z}\def\ColorY{Z}\def\ColorZ{Z}\def\CubeOpacity{0.4}}
					{XZZ}{\def\ColorX{X}\def\ColorY{Z}\def\ColorZ{Z}}
					{ZXZ}{\def\ColorX{Z}\def\ColorY{X}\def\ColorZ{Z}}
					{ZZX}{\def\ColorX{Z}\def\ColorY{Z}\def\ColorZ{X}}
					{ZXX}{\def\ColorX{Z}\def\ColorY{X}\def\ColorZ{X}}
					{XZX}{\def\ColorX{X}\def\ColorY{Z}\def\ColorZ{X}}
					{XXZ}{\def\ColorX{X}\def\ColorY{X}\def\ColorZ{Z}}
					{XYZ}{\def\ColorX{X}\def\ColorY{Y}\def\ColorZ{Z}}
					{OOO}{\def\ColorX{gray}\def\ColorY{gray}\def\ColorZ{gray}}
				}

				% Draw cube faces
				\ifdefined\NodeType
					\ifthenelse{\equal{\NodeType}{O}}{
						\def\CubeSize{0.1}
						\def\CubeOffset{0.05}
					}{
						\def\CubeSize{0.2}
						\def\CubeOffset{0.1}
					}
				\else
					\def\CubeSize{0.2}
					\def\CubeOffset{0.1}
				\fi

				% TODO: Try drawing a black square with a slightly smaller coloured square within it.
				\fill[\ColorX, opacity = \CubeOpacity] ([shift={(-\CubeOffset + \CubeSize, -\CubeOffset    , -\CubeOffset    )}] node\Identifier)
					  -- ([shift={(-\CubeOffset + \CubeSize, -\CubeOffset + \CubeSize, -\CubeOffset    )}] node\Identifier)
					  -- ([shift={(-\CubeOffset + \CubeSize, -\CubeOffset + \CubeSize, -\CubeOffset + \CubeSize)}] node\Identifier)
					  -- ([shift={(-\CubeOffset + \CubeSize, -\CubeOffset    , -\CubeOffset + \CubeSize)}] node\Identifier)
					  -- cycle;
		
				\fill[\ColorY, opacity = \CubeOpacity] ([shift={(-\CubeOffset    , -\CubeOffset + \CubeSize, -\CubeOffset    )}] node\Identifier)
					  -- ([shift={(-\CubeOffset + \CubeSize, -\CubeOffset + \CubeSize, -\CubeOffset    )}] node\Identifier)
					  -- ([shift={(-\CubeOffset + \CubeSize, -\CubeOffset + \CubeSize, -\CubeOffset + \CubeSize)}] node\Identifier)
					  -- ([shift={(-\CubeOffset    , -\CubeOffset + \CubeSize, -\CubeOffset + \CubeSize)}] node\Identifier)
					  -- cycle;
		
				\fill[\ColorZ, opacity = \CubeOpacity] ([shift={(-\CubeOffset    , -\CubeOffset    , -\CubeOffset + \CubeSize)}] node\Identifier)
					  -- ([shift={(-\CubeOffset + \CubeSize, -\CubeOffset    , -\CubeOffset + \CubeSize)}] node\Identifier)
					  -- ([shift={(-\CubeOffset + \CubeSize, -\CubeOffset + \CubeSize, -\CubeOffset + \CubeSize)}] node\Identifier)
					  -- ([shift={(-\CubeOffset    , -\CubeOffset + \CubeSize, -\CubeOffset + \CubeSize)}] node\Identifier)
					  -- cycle;
		
				\draw[border, opacity = \CubeOpacity] ([shift={(-\CubeOffset + \CubeSize, -\CubeOffset    , -\CubeOffset    )}] node\Identifier)
					  -- ([shift={(-\CubeOffset + \CubeSize, -\CubeOffset + \CubeSize, -\CubeOffset    )}] node\Identifier)
					  -- ([shift={(-\CubeOffset + \CubeSize, -\CubeOffset + \CubeSize, -\CubeOffset + \CubeSize)}] node\Identifier)
					  -- ([shift={(-\CubeOffset + \CubeSize, -\CubeOffset    , -\CubeOffset + \CubeSize)}] node\Identifier)
					  -- cycle;
		
				\draw[border, opacity = \CubeOpacity] ([shift={(-\CubeOffset    , -\CubeOffset + \CubeSize, -\CubeOffset    )}] node\Identifier)
					  -- ([shift={(-\CubeOffset + \CubeSize, -\CubeOffset + \CubeSize, -\CubeOffset    )}] node\Identifier)
					  -- ([shift={(-\CubeOffset + \CubeSize, -\CubeOffset + \CubeSize, -\CubeOffset + \CubeSize)}] node\Identifier)
					  -- ([shift={(-\CubeOffset    , -\CubeOffset + \CubeSize, -\CubeOffset + \CubeSize)}] node\Identifier)
					  -- cycle;
		
				\draw[border, opacity = \CubeOpacity] ([shift={(-\CubeOffset    , -\CubeOffset    , -\CubeOffset + \CubeSize)}] node\Identifier)
					  -- ([shift={(-\CubeOffset + \CubeSize, -\CubeOffset    , -\CubeOffset + \CubeSize)}] node\Identifier)
					  -- ([shift={(-\CubeOffset + \CubeSize, -\CubeOffset + \CubeSize, -\CubeOffset + \CubeSize)}] node\Identifier)
					  -- ([shift={(-\CubeOffset    , -\CubeOffset + \CubeSize, -\CubeOffset + \CubeSize)}] node\Identifier)
					  -- cycle;

				% TODO: Adapt to other than XYZ
				\ifdefined\ShowNodeLabels
					\IfStrEqCase{\ShowNodeLabels}{
						{show}{
							\node at ([shift={(-\CubeOffset + \CubeSize, 0, 0)}] node\Identifier)
								{\scalebox{0.6}{\tt\ColorX}};
							\node at ([shift={(0, -\CubeOffset + \CubeSize, 0)}] node\Identifier)
								{\scalebox{0.6}{\tt\ColorY}};
							\node at ([shift={(0, 0, -\CubeOffset + \CubeSize)}] node\Identifier)
								{\scalebox{0.6}{\tt\ColorZ}};
						}
						{hide}{}
					}
				\fi
			}
		}
	\endgroup
}

\newcommand{\Edge}[3][]{
	\begingroup
		\tikzset{zx/edge/.cd, #1}
		\draw[edge, white, line width = 2.25pt, shorten <= 6pt, shorten >= 6pt] (node#2) -- (node#3);
		\ifdefined\EdgeType
			\draw[edge, \EdgeType, shorten <= 6pt, shorten >= 6pt] (node#2) -- (node#3);
		\else
			\draw[edge, identity, shorten <= 6pt, shorten >= 6pt] (node#2) -- (node#3);
		\fi
		\ifdefined\EdgeAxis
			\draw[edge, thick, \EdgeAxis, shorten <= 6pt, shorten >= 6pt] (node#2) -- (node#3);
		\fi
	\endgroup
}

\newcommand{\ZXGraph}[2][]{
	\begingroup
		\tikzset{zx/graph/.cd, #1}
		\ifdefined\GraphNodeStyle\else
			\def\GraphNodeStyle{spider}
		\fi

		\ifdefined\RotationX\else
			\def\RotationX{65}
		\fi
		\ifdefined\RotationZ\else
			\def\RotationZ{135}
		\fi
		
		\tdplotsetmaincoords{\RotationX}{\RotationZ}

		\begin{tikzpicture}[tdplot_main_coords]
			{#2} % Layout of the ZX-Graph (i.e. nodes and edges) along with plane-constraints
		\end{tikzpicture}
	\endgroup
}

% Correspondence between BlockGraph and Volumetric ZX-Graph notation.
\newcommand{\Legend}{
	\ZXGraph[labels=hide]{
		% Summary of planes, axes and associated colours
		\begin{scope}[scale=0.75, shift={(2.25, 0, 2.5)}]
			\draw[-stealth] (0,0,0) -- +(1,0,0);
			\node[shift={(0.15, 0, 0)}] at (1,0,0) {\tiny $x$};

			\draw[-stealth] (0,0,0) -- +(0,1,0);
			\node[shift={(0, 0.15, 0)}] at (0,1,0) {\tiny $y$};

			\draw[-stealth] (0,0,0) -- +(0,0,1);
			\node[shift={(0, 0, 0.15)}] at (0,0,1) {\tiny $z$};

			\begin{scope}[scale=3]
				\Node[kind=XYZ, style=cube, labels=show]{(0.5,0.5,0.355)}
			\end{scope}
		\end{scope}

		% Correspondence between spiders w/ plane constraints and cube kinds
		\begin{scope}[shift={(0,0,0)}]
			% Type X <=> Kinds: XZZ, ZXZ, ZZX
			\Node[kind=XZZ, identifier=XZZ]{(0,0,2)}
			\node at (0,0.5,2.1625) {$\equiv$};
			\Node[kind=XZZ, style=cube]{(0,1,2.325)}

			\Node[kind=ZXZ, identifier=ZXZ]{(0,0,1.5)}
			\node at (0,0.5,1.6625) {$\equiv$};
			\Node[kind=ZXZ, style=cube]{(0,1,1.825)}

			\Node[kind=ZZX, identifier=ZZX]{(0,0,1.0)}
			\node at (0,0.5,1.1625) {$\equiv$};
			\Node[kind=ZZX, style=cube]{(0,1,1.325)}
		\end{scope}

		% Correspondence between spiders w/ plane constraints and cube kinds
		\begin{scope}[shift={(0, 2, 0.65)}]
			% Type Z <=> Kinds : ZXX, XZX, XXZ
			\Node[kind=ZXX, identifier=ZXX]{(0,0,2)}
			\node at (0,0.5,2.1625) {$\equiv$};
			\Node[kind=ZXX, style=cube]{(0,1,2.325)}

			\Node[kind=XZX, identifier=XZX]{(0,0,1.5)}
			\node at (0,0.5,1.6625) {$\equiv$};
			\Node[kind=XZX, style=cube]{(0,1,1.825)}

			\Node[kind=XXZ, identifier=XXZ]{(0,0,1.0)}
			\node at (0,0.5,1.1625) {$\equiv$};
			\Node[kind=XXZ, style=cube]{(0,1,1.325)}
		\end{scope}

		% Special cases of spider w/o plane constraints with adhoc cube kind
		\begin{scope}[shift={(0, -3, -0.5)}]
			% Kind XXX
			\Node[kind=XXX]{(0, 0, 0)}
			\node at (0, 0.5, 0.1625) {$\equiv$};
			\Node[kind=XZZ, style=cube]{(0, 1, 0.3250)}
			\node at (0, 1.5, 0.4875) {\tiny or};
			\Node[kind=ZXZ, style=cube]{(0, 2, 0.6500)}
			\node at (0, 2.5, 0.8125) {\tiny or};
			\Node[kind=ZZX, style=cube]{(0, 3, 0.9750)}
			\node at (0, 3.5, 1.1375) {$\equiv$};
			\Node[kind=XXX, style=cube]{(0, 4, 1.3000)}
		\end{scope}

		% Special cases of spider w/o plane constraints with adhoc cube kind
		\begin{scope}[shift={(0, +2, 1.125)}]
			% Kind ZZZ
			\Node[kind=ZZZ]{(0, 0, 0)}
			\node at (0, 0.5, 0.1625) {$\equiv$};
			\Node[kind=ZXX, style=cube]{(0, 1, 0.3250)}
			\node at (0, 1.5, 0.4875) {\tiny or};
			\Node[kind=XZX, style=cube]{(0, 2, 0.6500)}
			\node at (0, 2.5, 0.8125) {\tiny or};
			\Node[kind=XXZ, style=cube]{(0, 3, 0.9750)}
			\node at (0, 3.5, 1.1375) {$\equiv$};
			\Node[kind=ZZZ, style=cube]{(0, 4, 1.3000)}
		\end{scope}

		% Edge description
		\begin{scope}[shift={(0, 4, 3.325)}]
			\coordinate (nodeX0) at (0, +0.4, +0.4);
			\coordinate (nodeX1) at (0, -0.4, -0.4);
			\Edge[axis=X]{X0}{X1}
			\node at (0, 1, +0.325) {\scalebox{0.6}{$\delta_{\scriptscriptstyle x} = \pm 1$}};

			\coordinate (nodeY0) at (0, -0.4, -0.4);
			\coordinate (nodeY1) at (0, +0.4, -0.6);
			\Edge[axis=Y]{Y0}{Y1}
			\node at (0, 1, -0.2) {\scalebox{0.6}{$\delta_{\scriptscriptstyle y} = \pm 1$}};

			\coordinate (nodeZ0) at (0, 0, -0.625);
			\coordinate (nodeZ1) at (0, 0, -1.4);
			\Edge[axis=Z]{Z0}{Z1}
			\node at (0, 1, -0.7) {\scalebox{0.6}{$\delta_{\scriptscriptstyle z} = \pm 1$}};
		\end{scope}
	}
}