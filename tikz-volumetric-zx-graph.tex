\usepackage{pgfplots}
\pgfplotsset{compat=1.18}

\usepackage{ifthen}
\usepackage{xstring}

\usepackage{tikz}
\usepackage{tikz-3dplot}

\tikzstyle{border}=[black, line width=0.25pt, rounded corners = 0.125pt]
\tikzstyle{edge}=[line cap = round, ultra thick, shorten <= 6.5pt, shorten >= 6.5pt]
\tikzstyle{identity}=[darkgray!90]
\tikzstyle{hadamard}=[yellow!75!black!75]

\tikzstyle{axis}=[line cap=round, thick]
\tikzstyle{U}=[lightgray]
\tikzstyle{X}=[  red!75!black!50]
\tikzstyle{Y}=[green!75!black!50]
\tikzstyle{Z}=[ blue!75!black!50]
\tikzstyle{O}=[darkgray!90, line width = 1pt]

\tikzset{
	% Graph parameters
	zx/graph/style/.initial=zx, % global style for all nodes; zx or bg
	zx/graph/labels/.initial=show,    % whether to show node labels or not
	zx/graph/rotationX/.initial=65,   % Rotation along x-axis for tikz-3dplot
	zx/graph/rotationZ/.initial=120,  % Rotation along z-axis for tikz-3dplot
	% Node parameters
	zx/node/kind/.initial=UUU,
	zx/node/type/.initial=U,
	zx/node/plane/.initial=U,
	zx/node/identifier/.store in=\Identifier, % Used to connect edges
	zx/node/style/.initial=,
	% Edge parameters
	zx/edge/axis/.initial=U, % Edge represents change of +1/-1 between two adjacent nodes along this axis
	zx/edge/type/.initial=identity, % identity or hadamard
	zx/edge/md/.store in=\ManhattanDistance, % Manhattan Distance
}

\newcommand{\Node}[2][]{
	\begingroup
		\tikzset{zx/node/.cd, #1}

		\def\NodeKind{\pgfkeysvalueof{/tikz/zx/node/kind}}
		\def\NodeType{\pgfkeysvalueof{/tikz/zx/node/type}}
		\def\NodePlane{\pgfkeysvalueof{/tikz/zx/node/plane}}
		\def\NodeStyle{\pgfkeysvalueof{/tikz/zx/node/style}}
		\ifthenelse{\equal{\NodeStyle}{}}{
			\def\NodeStyle{\GraphStyle}
		}{
			% Keep it as it is.
		}

		% Set empty identifier if none provided
		\ifdefined\Identifier\else
			\def\Identifier{}
		\fi

		% Prepare the coordinate of the center of the node
		\coordinate (node\Identifier) at #2;
		\node (\Identifier) at (node\Identifier) {};

		% Derive node kind from type/plane and vice-versa
		% TODO: warning when kind and type/plane are both provided
		% TODO: error when kind and type/plane are conflicting specifications
		\ifthenelse{\not\equal{\NodeKind}{UUU}}{
			\IfStrEqCase{\NodeKind}{
				{XXX}{\def\NodeType{X}\def\NodePlane{U}}
				{ZZZ}{\def\NodeType{Z}\def\NodePlane{U}}
				{XZZ}{\def\NodeType{X}\def\NodePlane{X}}
				{ZXZ}{\def\NodeType{X}\def\NodePlane{Y}}
				{ZZX}{\def\NodeType{X}\def\NodePlane{Z}}
				{ZXX}{\def\NodeType{Z}\def\NodePlane{X}}
				{XZX}{\def\NodeType{Z}\def\NodePlane{Y}}
				{XXZ}{\def\NodeType{Z}\def\NodePlane{Z}}
				{OOO}{\def\NodeType{O}}
				{XYZ}{}
			}
		}{
			\IfStrEqCase{\NodeType}{
				{X}{
					\ifdefined\NodePlane
						\IfStrEqCase{\NodePlane}{
							{X}{\def\NodeKind{XZZ}}
							{Y}{\def\NodeKind{ZXZ}}
							{Z}{\def\NodeKind{ZZX}}
							{U}{\def\NodeKind{XXX}}
						}
					\else
						\def\NodeKind{XXX}
					\fi
				}
				{Z}{
					\ifdefined\NodePlane
						\IfStrEqCase{\NodePlane}{
							{X}{\def\NodeKind{ZXX}}
							{Y}{\def\NodeKind{XZX}}
							{Z}{\def\NodeKind{XXZ}}
							{U}{\def\NodeKind{ZZZ}}
						}
					\else
						\def\NodeKind{ZZZ}
					\fi
				}
				{O}{
					\def\NodeKind{OOO}
				}
				{U}{
					\def\NodeKind{UUU}
				}
			}
		}

		\IfStrEqCase{\NodeStyle}{
			{zx}{
				% Draw disk
				\ifthenelse{\equal{\NodeType}{O}}{
					\fill[\NodeType] (node\Identifier) circle (2pt);
				}{
					\fill[\NodeType] (node\Identifier) circle (3pt);
				}
			
				% Draw plane constraint
				\ifthenelse{\not\equal{\NodeType}{O}}{
					\draw[\NodePlane, line width = 1pt] (node\Identifier) circle (4pt);
				}{
					% Do not draw
				}
			}
			{bg}{
				\def\CubeOpacity{1.0}
				\IfStrEqCase{\NodeKind}{
					{UUU}{\def\ColorX{U}\def\ColorY{U}\def\ColorZ{U}}
					{XXX}{\def\ColorX{X}\def\ColorY{X}\def\ColorZ{X}}
					{YYY}{\def\ColorX{Y}\def\ColorY{Y}\def\ColorZ{Y}}
					{ZZZ}{\def\ColorX{Z}\def\ColorY{Z}\def\ColorZ{Z}}
					{XZZ}{\def\ColorX{X}\def\ColorY{Z}\def\ColorZ{Z}}
					{ZXZ}{\def\ColorX{Z}\def\ColorY{X}\def\ColorZ{Z}}
					{ZZX}{\def\ColorX{Z}\def\ColorY{Z}\def\ColorZ{X}}
					{ZXX}{\def\ColorX{Z}\def\ColorY{X}\def\ColorZ{X}}
					{XZX}{\def\ColorX{X}\def\ColorY{Z}\def\ColorZ{X}}
					{XXZ}{\def\ColorX{X}\def\ColorY{X}\def\ColorZ{Z}}
					{XYZ}{\def\ColorX{X}\def\ColorY{Y}\def\ColorZ{Z}}
					{OOO}{\def\ColorX{O}\def\ColorY{O}\def\ColorZ{O}}
				}

				% Draw cube faces
				\ifdefined\NodeType
					\ifthenelse{\equal{\NodeType}{O}}{
						\def\CubeSize{0.100}
						\def\CubeOffset{0.050}
						\def\FaceSize{0.070}
						\def\FaceOffset{0.035}
					}{
						\def\CubeSize{0.200}
						\def\CubeOffset{0.100}
						\def\FaceSize{0.125}
						\def\FaceOffset{0.0625}
					}
				\else
					\def\CubeSize{0.2}
					\def\CubeOffset{0.1}
				\fi

				\ifthenelse{\equal{\NodeKind}{XXX} \or \equal{\NodeKind}{ZZZ}}{
					% TODO: Try a black square with a slightly smaller coloured square inside
					\fill[U, opacity = \CubeOpacity]
							 ([shift={(-\CubeOffset + \CubeSize, -\CubeOffset            , -\CubeOffset            )}] node\Identifier)
						  -- ([shift={(-\CubeOffset + \CubeSize, -\CubeOffset + \CubeSize, -\CubeOffset            )}] node\Identifier)
						  -- ([shift={(-\CubeOffset + \CubeSize, -\CubeOffset + \CubeSize, -\CubeOffset + \CubeSize)}] node\Identifier)
						  -- ([shift={(-\CubeOffset + \CubeSize, -\CubeOffset            , -\CubeOffset + \CubeSize)}] node\Identifier)
						  -- cycle;

					\fill[U, opacity = \CubeOpacity]
							 ([shift={(-\CubeOffset            , -\CubeOffset + \CubeSize, -\CubeOffset            )}] node\Identifier)
						  -- ([shift={(-\CubeOffset + \CubeSize, -\CubeOffset + \CubeSize, -\CubeOffset            )}] node\Identifier)
						  -- ([shift={(-\CubeOffset + \CubeSize, -\CubeOffset + \CubeSize, -\CubeOffset + \CubeSize)}] node\Identifier)
						  -- ([shift={(-\CubeOffset            , -\CubeOffset + \CubeSize, -\CubeOffset + \CubeSize)}] node\Identifier)
						  -- cycle;

					\fill[U, opacity = \CubeOpacity]
							 ([shift={(-\CubeOffset            , -\CubeOffset            , -\CubeOffset + \CubeSize)}] node\Identifier)
						  -- ([shift={(-\CubeOffset + \CubeSize, -\CubeOffset            , -\CubeOffset + \CubeSize)}] node\Identifier)
						  -- ([shift={(-\CubeOffset + \CubeSize, -\CubeOffset + \CubeSize, -\CubeOffset + \CubeSize)}] node\Identifier)
						  -- ([shift={(-\CubeOffset            , -\CubeOffset + \CubeSize, -\CubeOffset + \CubeSize)}] node\Identifier)
						  -- cycle;

					\fill[\ColorX, rounded corners = 0.25pt, opacity = \CubeOpacity]
							 ([shift={(-\CubeOffset + \CubeSize, -\FaceOffset            , -\FaceOffset            )}] node\Identifier)
						  -- ([shift={(-\CubeOffset + \CubeSize, -\FaceOffset + \FaceSize, -\FaceOffset            )}] node\Identifier)
						  -- ([shift={(-\CubeOffset + \CubeSize, -\FaceOffset + \FaceSize, -\FaceOffset + \FaceSize)}] node\Identifier)
						  -- ([shift={(-\CubeOffset + \CubeSize, -\FaceOffset            , -\FaceOffset + \FaceSize)}] node\Identifier)
						  -- cycle;

					\fill[\ColorY, rounded corners = 0.25pt, opacity = \CubeOpacity]
							 ([shift={(-\FaceOffset            , -\CubeOffset + \CubeSize, -\FaceOffset            )}] node\Identifier)
						  -- ([shift={(-\FaceOffset + \FaceSize, -\CubeOffset + \CubeSize, -\FaceOffset            )}] node\Identifier)
						  -- ([shift={(-\FaceOffset + \FaceSize, -\CubeOffset + \CubeSize, -\FaceOffset + \FaceSize)}] node\Identifier)
						  -- ([shift={(-\FaceOffset            , -\CubeOffset + \CubeSize, -\FaceOffset + \FaceSize)}] node\Identifier)
						  -- cycle;

					\fill[\ColorZ, rounded corners = 0.25pt, opacity = \CubeOpacity]
							 ([shift={(-\FaceOffset            , -\FaceOffset            , -\CubeOffset + \CubeSize)}] node\Identifier)
						  -- ([shift={(-\FaceOffset + \FaceSize, -\FaceOffset            , -\CubeOffset + \CubeSize)}] node\Identifier)
						  -- ([shift={(-\FaceOffset + \FaceSize, -\FaceOffset + \FaceSize, -\CubeOffset + \CubeSize)}] node\Identifier)
						  -- ([shift={(-\FaceOffset            , -\FaceOffset + \FaceSize, -\CubeOffset + \CubeSize)}] node\Identifier)
						  -- cycle;
				}{
					\fill[\ColorX, opacity = \CubeOpacity] ([shift={(-\CubeOffset + \CubeSize, -\CubeOffset    , -\CubeOffset    )}] node\Identifier)
						  -- ([shift={(-\CubeOffset + \CubeSize, -\CubeOffset + \CubeSize, -\CubeOffset    )}] node\Identifier)
						  -- ([shift={(-\CubeOffset + \CubeSize, -\CubeOffset + \CubeSize, -\CubeOffset + \CubeSize)}] node\Identifier)
						  -- ([shift={(-\CubeOffset + \CubeSize, -\CubeOffset    , -\CubeOffset + \CubeSize)}] node\Identifier)
						  -- cycle;
			
					\fill[\ColorY, opacity = \CubeOpacity] ([shift={(-\CubeOffset    , -\CubeOffset + \CubeSize, -\CubeOffset    )}] node\Identifier)
						  -- ([shift={(-\CubeOffset + \CubeSize, -\CubeOffset + \CubeSize, -\CubeOffset    )}] node\Identifier)
						  -- ([shift={(-\CubeOffset + \CubeSize, -\CubeOffset + \CubeSize, -\CubeOffset + \CubeSize)}] node\Identifier)
						  -- ([shift={(-\CubeOffset    , -\CubeOffset + \CubeSize, -\CubeOffset + \CubeSize)}] node\Identifier)
						  -- cycle;
			
					\fill[\ColorZ, opacity = \CubeOpacity] ([shift={(-\CubeOffset    , -\CubeOffset    , -\CubeOffset + \CubeSize)}] node\Identifier)
						  -- ([shift={(-\CubeOffset + \CubeSize, -\CubeOffset    , -\CubeOffset + \CubeSize)}] node\Identifier)
						  -- ([shift={(-\CubeOffset + \CubeSize, -\CubeOffset + \CubeSize, -\CubeOffset + \CubeSize)}] node\Identifier)
						  -- ([shift={(-\CubeOffset    , -\CubeOffset + \CubeSize, -\CubeOffset + \CubeSize)}] node\Identifier)
						  -- cycle;
				}

				\draw[border, opacity = \CubeOpacity]
						 ([shift={(-\CubeOffset + \CubeSize, -\CubeOffset            , -\CubeOffset            )}] node\Identifier)
					  -- ([shift={(-\CubeOffset + \CubeSize, -\CubeOffset + \CubeSize, -\CubeOffset            )}] node\Identifier)
					  -- ([shift={(-\CubeOffset + \CubeSize, -\CubeOffset + \CubeSize, -\CubeOffset + \CubeSize)}] node\Identifier)
					  -- ([shift={(-\CubeOffset + \CubeSize, -\CubeOffset            , -\CubeOffset + \CubeSize)}] node\Identifier)
					  -- cycle;

				\draw[border, opacity = \CubeOpacity]
						 ([shift={(-\CubeOffset            , -\CubeOffset + \CubeSize, -\CubeOffset            )}] node\Identifier)
					  -- ([shift={(-\CubeOffset + \CubeSize, -\CubeOffset + \CubeSize, -\CubeOffset            )}] node\Identifier)
					  -- ([shift={(-\CubeOffset + \CubeSize, -\CubeOffset + \CubeSize, -\CubeOffset + \CubeSize)}] node\Identifier)
					  -- ([shift={(-\CubeOffset            , -\CubeOffset + \CubeSize, -\CubeOffset + \CubeSize)}] node\Identifier)
					  -- cycle;

				\draw[border, opacity = \CubeOpacity]
						 ([shift={(-\CubeOffset            , -\CubeOffset            , -\CubeOffset + \CubeSize)}] node\Identifier)
					  -- ([shift={(-\CubeOffset + \CubeSize, -\CubeOffset            , -\CubeOffset + \CubeSize)}] node\Identifier)
					  -- ([shift={(-\CubeOffset + \CubeSize, -\CubeOffset + \CubeSize, -\CubeOffset + \CubeSize)}] node\Identifier)
					  -- ([shift={(-\CubeOffset            , -\CubeOffset + \CubeSize, -\CubeOffset + \CubeSize)}] node\Identifier)
					  -- cycle;
			}
		}

		% Display the node label if requested
		\ifthenelse{\equal{\ShowNodeLabels}{show}}{
			\node[white, scale=0.25] at (node\Identifier) {\tt\Identifier};
		}{
			% Do nothing
		}

	\endgroup
}

\newcommand{\Edge}[3][]{
	\begingroup
		\tikzset{zx/edge/.cd, #1}

		\def\EdgeAxis{\pgfkeysvalueof{/tikz/zx/edge/axis}}
		\def\EdgeType{\pgfkeysvalueof{/tikz/zx/edge/type}}

		\draw[edge, white, line width = 2.5pt] (node#2) -- (node#3);
		\draw[edge, \EdgeType] (node#2) -- (node#3);
		\draw[edge, thick, \EdgeAxis] (node#2) -- (node#3);
	\endgroup
}

\newcommand{\ManhattanDistance}[3][]{
	\begingroup
		\tikzset{zx/edge/.cd, #1}

		\draw[edge, darkgray, shorten <= 6pt, shorten >= 6pt]
			(node#2) -- node[white, sloped] {\scalebox{0.2}{\tt\ManhattanDistance}} (node#3);

	\endgroup
}

\newcommand{\ZXGraph}[2][]{
	\begingroup
		\tikzset{zx/graph/.cd, #1}
		\def\GraphStyle{\pgfkeysvalueof{/tikz/zx/graph/style}}
		\def\ShowNodeLabels{\pgfkeysvalueof{/tikz/zx/graph/labels}}
		\def\RotationX{\pgfkeysvalueof{/tikz/zx/graph/rotationX}}
		\def\RotationZ{\pgfkeysvalueof{/tikz/zx/graph/rotationZ}}
		
		\tdplotsetmaincoords{\RotationX}{\RotationZ}

		\begin{tikzpicture}[tdplot_main_coords]
			{#2} % Layout of the ZX-Graph (i.e. nodes and edges) along with plane-constraints
		\end{tikzpicture}
	\endgroup
}

% Correspondence between BlockGraph and Volumetric ZX-Graph notation.
\newcommand{\Legend}{
	\ZXGraph[rotationX = 65, rotationZ = 135]{
		% Summary of planes, axes and associated colours
		\begin{scope}[scale=0.75, shift={(2.25, 0, 2.5)}]
			\draw[-stealth] (0,0,0) -- +(1,0,0);
			\node[shift={(0.15, 0, 0)}] at (1,0,0) {\tiny $x$};

			\draw[-stealth] (0,0,0) -- +(0,1,0);
			\node[shift={(0, 0.15, 0)}] at (0,1,0) {\tiny $y$};

			\draw[-stealth] (0,0,0) -- +(0,0,1);
			\node[shift={(0, 0, 0.15)}] at (0,0,1) {\tiny $z$};

			\begin{scope}[scale=3]
				\Node[kind=XYZ, style=bg]{(0.5,0.5,0.355)}
			\end{scope}
		\end{scope}

		% Correspondence between spiders w/ plane constraints and cube kinds
		\begin{scope}[shift={(0,0,0)}]
			% Type X <=> Kinds: XZZ, ZXZ, ZZX
			\Node[kind=XZZ]{(0,0,2)}
			\node at (0,0.5,2.1625) {$\equiv$};
			\Node[kind=XZZ, style=bg]{(0,1,2.325)}

			\Node[kind=ZXZ]{(0,0,1.5)}
			\node at (0,0.5,1.6625) {$\equiv$};
			\Node[kind=ZXZ, style=bg]{(0,1,1.825)}

			\Node[kind=ZZX]{(0,0,1.0)}
			\node at (0,0.5,1.1625) {$\equiv$};
			\Node[kind=ZZX, style=bg]{(0,1,1.325)}
		\end{scope}

		% Correspondence between spiders w/ plane constraints and cube kinds
		\begin{scope}[shift={(0, 2, 0.65)}]
			% Type Z <=> Kinds : ZXX, XZX, XXZ
			\Node[kind=ZXX]{(0,0,2)}
			\node at (0,0.5,2.1625) {$\equiv$};
			\Node[kind=ZXX, style=bg]{(0,1,2.325)}

			\Node[kind=XZX]{(0,0,1.5)}
			\node at (0,0.5,1.6625) {$\equiv$};
			\Node[kind=XZX, style=bg]{(0,1,1.825)}

			\Node[kind=XXZ]{(0,0,1.0)}
			\node at (0,0.5,1.1625) {$\equiv$};
			\Node[kind=XXZ, style=bg]{(0,1,1.325)}
		\end{scope}

		% Special cases of spider w/o plane constraints with adhoc cube kind
		\begin{scope}[shift={(0, -3, -0.5)}]
			% Kind XXX
			\Node[kind=XXX]{(0, 0, 0)}
			\node at (0, 0.5, 0.1625) {$\equiv$};
			\Node[kind=XZZ, style=bg]{(0, 1, 0.3250)}
			\node at (0, 1.5, 0.4875) {\tiny or};
			\Node[kind=ZXZ, style=bg]{(0, 2, 0.6500)}
			\node at (0, 2.5, 0.8125) {\tiny or};
			\Node[kind=ZZX, style=bg]{(0, 3, 0.9750)}
			\node at (0, 3.5, 1.1375) {$\equiv$};
			\Node[kind=XXX, style=bg]{(0, 4, 1.3000)}
		\end{scope}

		% Special cases of spider w/o plane constraints with adhoc cube kind
		\begin{scope}[shift={(0, +2, 1.125)}]
			% Kind ZZZ
			\Node[kind=ZZZ]{(0, 0, 0)}
			\node at (0, 0.5, 0.1625) {$\equiv$};
			\Node[kind=ZXX, style=bg]{(0, 1, 0.3250)}
			\node at (0, 1.5, 0.4875) {\tiny or};
			\Node[kind=XZX, style=bg]{(0, 2, 0.6500)}
			\node at (0, 2.5, 0.8125) {\tiny or};
			\Node[kind=XXZ, style=bg]{(0, 3, 0.9750)}
			\node at (0, 3.5, 1.1375) {$\equiv$};
			\Node[kind=ZZZ, style=bg]{(0, 4, 1.3000)}
		\end{scope}

		% Edge description
		\begin{scope}[shift={(0, 4, 3.325)}]
			\coordinate (nodeX0) at (0, +0.4, +0.4);
			\coordinate (nodeX1) at (0, -0.4, -0.4);
			\Edge[axis=X]{X0}{X1}
			\node at (0, 1, +0.325) {\scalebox{0.6}{$\delta_{\scriptscriptstyle x} = \pm 1$}};

			\coordinate (nodeY0) at (0, -0.4, -0.4);
			\coordinate (nodeY1) at (0, +0.4, -0.6);
			\Edge[axis=Y]{Y0}{Y1}
			\node at (0, 1, -0.2) {\scalebox{0.6}{$\delta_{\scriptscriptstyle y} = \pm 1$}};

			\coordinate (nodeZ0) at (0, 0, -0.625);
			\coordinate (nodeZ1) at (0, 0, -1.4);
			\Edge[axis=Z]{Z0}{Z1}
			\node at (0, 1, -0.7) {\scalebox{0.6}{$\delta_{\scriptscriptstyle z} = \pm 1$}};
		\end{scope}
	}
}