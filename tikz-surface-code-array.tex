\usepackage{pgfplots}
\pgfplotsset{compat=1.18}

\usepackage{ifthen}
\usepackage{xstring}

\usepackage{tikz}
\usetikzlibrary{math}

\tikzstyle{data}=[darkgray!80]
\tikzstyle{stabilizer}=[line width = 1pt, opacity=0.35]
\tikzstyle{X}=[  red!75!black!75]
\tikzstyle{Y}=[green!75!black!75]
\tikzstyle{Z}=[ blue!75!black!75]

\tikzset{
	% Array parameters
	sc/array/order/.initial=1,
	sc/array/qubits/.initial=show,
	sc/array/labels/.initial=hide,
	% Needed to properly place the 2-qubit stabilizers.
	% This can be inferred from the parity of the coordinates but I don't know how to do that in tikz-math.
	sc/array/offset/.initial=0,
	sc/array/coordinates/.initial=hide,
	% Controls the offset of the 2-qubit stabilizers along the perimeter (0 or 1)
	sc/array/perimeter/.initial=0,
	% Controls whether there is a Hadamard flip on the surface code
	sc/array/hadamard/.initial=0,
	% Logical qubit parameters
	sc/logical/qubit/order/.store in=\Order,
	sc/logical/qubit/orderH/.initial=0,
	sc/logical/qubit/orderW/.initial=0,
	sc/logical/qubit/offset/.initial=0,
	sc/logical/qubit/position/.initial={(1,1)},
	sc/logical/qubit/stabilizers/.initial=hide,
	% Logical gate parameters
	sc/logical/gate/type/.initial=U
}

\tikzmath{
	function Plaquette(\RowDistance, \ColDistance, \Row, \Col, \Opacity) {
		% Place two-qubits stabilizers on the LEFT
		if \Col == 0 && Mod(\Row, \RowDistance) != 0 && Mod(\Row+\Col, 2) == \Offset then {
			if Mod(\Row+\Col, 2) == \Hadamard then {
				{ % Z-stabilizers
					\fill[stabilizer, Z, opacity = \Opacity] (\Col + 1 - \Trim, \Row + \Trim) 
					    arc[start angle=270, end angle=90, radius=0.5 - \Trim]
					    -- (\Col + 1 - \Trim, \Row + \Trim) -- cycle;
					\node[Z, opacity = \Opacity] (M\Col\Row) at (\Col + 0.775, \Row + 0.5) {
						\ifthenelse{\equal{\ShowStabilizersLabels}{show}}{\tt\strut Z}{}
					};
				};
			} else {
				{ % X-stabilizers
					\fill[stabilizer, X, opacity = \Opacity] (\Col + 1 - \Trim, \Row + \Trim) 
					    arc[start angle=270, end angle=90, radius=0.5 - \Trim]
					    -- (\Col + 1 - \Trim, \Row + \Trim) -- cycle;
					\node[X, opacity = \Opacity] (M\Col\Row) at (\Col + 0.775, \Row + 0.5) {
						\ifthenelse{\equal{\ShowStabilizersLabels}{show}}{\tt\strut X}{}
					};
				};
			};
		};
		% Place two-qubits stabilizers on the RIGHT
		if \Col == \ColDistance && Mod(\Row, \RowDistance) != 0 && Mod(\Row+\Col, 2) == \Offset then {
			if Mod(\Row+\Col, 2) == \Hadamard then {
				{ % Z-stabilizers
					\fill[stabilizer, Z, opacity = \Opacity] (\Col + \Trim, \Row + \Trim) 
					    arc[start angle=270, end angle=450, radius=0.5 - \Trim]
					    -- (\Col + \Trim, \Row + \Trim) -- cycle;
					\node[Z, opacity = \Opacity] (M\Col\Row) at (\Col + 0.225, \Row + 0.5) {
						\ifthenelse{\equal{\ShowStabilizersLabels}{show}}{\tt\strut Z}{}
					};
				};
			} else {
				{ % X-stabilizers
					\fill[stabilizer, X, opacity = \Opacity] (\Col + \Trim, \Row + \Trim) 
					    arc[start angle=270, end angle=450, radius=0.5 - \Trim]
					    -- (\Col + \Trim, \Row + \Trim) -- cycle;
					\node[X, opacity = \Opacity] (M\Col\Row) at (\Col + 0.225, \Row + 0.5) {
						\ifthenelse{\equal{\ShowStabilizersLabels}{show}}{\tt\strut X}{}
					};
				};
			};
		};
		% Place four-qubits stabilizers WITHIN the array
		if Mod(\Col, \ColDistance) != 0 && Mod(\Row, \RowDistance) != 0 then {
			if Mod(\Row+\Col, 2) == \Hadamard then {
				{
					\fill[stabilizer, Z, opacity = \Opacity] (\Col + \Trim, \Row + \Trim)
						rectangle (\Col + 1 - \Trim, \Row + 1 - \Trim);
					\node[Z, opacity = \Opacity] (M\Col\Row) at (\Col + 0.5, \Row + 0.5) {
						\ifthenelse{\equal{\ShowStabilizersLabels}{show}}{\tt\strut Z}{}
					};
				};
			} else {
				{
					\fill[stabilizer, X, opacity = \Opacity] (\Col + \Trim, \Row + \Trim)
						rectangle (\Col + 1 - \Trim, \Row + 1 - \Trim);
					\node[X, opacity = \Opacity] (M\Col\Row) at (\Col + 0.5, \Row + 0.5) {
						\ifthenelse{\equal{\ShowStabilizersLabels}{show}}{\tt\strut X}{}
					};
				};
			};
		};
		% Place two-qubits X-stabilizers at the BOTTOM
		if \Row == 0 && Mod(\Col, \ColDistance) != 0 && Mod(\Row+\Col, 2) != \Offset then {
			if Mod(\Row+\Col, 2) == \Hadamard then {
				{
					\fill[stabilizer, Z, opacity = \Opacity] (\Col + \Trim,\Row + 1 - \Trim) 
					    arc[start angle=180, end angle=360, radius=0.5 - \Trim]
					    -- (\Col + 1 - \Trim, \Row + 1 - \Trim) -- cycle;
					\node[Z, opacity = \Opacity] (M\Col\Row) at (\Col + 0.5, \Row + 0.725) {
						\ifthenelse{\equal{\ShowStabilizersLabels}{show}}{\tt\strut Z}{}
					};
				};
			} else {
				{
					\fill[stabilizer, X, opacity = \Opacity] (\Col + \Trim,\Row + 1 - \Trim) 
					    arc[start angle=180, end angle=360, radius=0.5 - \Trim]
					    -- (\Col + 1 - \Trim, \Row + 1 - \Trim) -- cycle;
					\node[X, opacity = \Opacity] (M\Col\Row) at (\Col + 0.5, \Row + 0.725) {
						\ifthenelse{\equal{\ShowStabilizersLabels}{show}}{\tt\strut X}{}
					};
				};
			};
		};
		% Place two-qubits X-stabilizers at the TOP
		if \Row == \RowDistance && Mod(\Col, \ColDistance) != 0 && Mod(\Row+\Col, 2) != \Offset then {
			if Mod(\Row+\Col, 2) == \Hadamard then {
				{
					\fill[stabilizer, Z, opacity = \Opacity] (\Col + \Trim,\Row + \Trim) 
					    arc[start angle=180, end angle=0, radius=0.5 - \Trim]
					    -- (\Col + 1 - \Trim, \Row + \Trim) -- cycle;
					\node[Z, opacity = \Opacity] (M\Col\Row) at (\Col + 0.5, \Row + 0.225) {
						\ifthenelse{\equal{\ShowStabilizersLabels}{show}}{\tt\strut Z}{}
					};
				};
			} else {
				{
					\fill[stabilizer, X, opacity = \Opacity] (\Col + \Trim,\Row + \Trim) 
					    arc[start angle=180, end angle=0, radius=0.5 - \Trim]
					    -- (\Col + 1 - \Trim, \Row + \Trim) -- cycle;
					\node[X, opacity = \Opacity] (M\Col\Row) at (\Col + 0.5, \Row + 0.225) {
						\ifthenelse{\equal{\ShowStabilizersLabels}{show}}{\tt\strut X}{}
					};
				};
			};
		};
	};
}

\newcommand{\SurfaceCodeArray}[3][]{
	\begingroup
		\tikzset{sc/array/.cd, #1}

		\def\Order{\pgfkeysvalueof{/tikz/sc/array/order}}
		\def\ShowQubits{\pgfkeysvalueof{/tikz/sc/array/qubits}}
		\def\ShowCoordinates{\pgfkeysvalueof{/tikz/sc/array/coordinates}}
		\def\ShowStabilizersLabels{\pgfkeysvalueof{/tikz/sc/array/labels}}
		\def\Perimeter{\pgfkeysvalueof{/tikz/sc/array/perimeter}}
		\def\Hadamard{\pgfkeysvalueof{/tikz/sc/array/hadamard}}

		\def\Offset{\Perimeter}

		\begin{tikzpicture}
			\tikzmath{
				real \Trim;
				\Trim = 1 / 128;
				integer \Distance;
				\Distance = 2*\Order + 1;
				integer \h;
				integer \v;
				% Place Stabilizer qubits
				for \row in {0,...,\Distance} {
					for \col in {0,...,\Distance} {
						Plaquette(\Distance, \Distance, \row, \col, 0.125);
					};
				};
			}

			% Draw the logical gates beneath the qubits
			{#3}

			\tikzmath{
				integer \row, \col;
				% Place Data qubits
				for \row in {1,...,\Distance} {
					for \col in {1,...,\Distance} {
						{
							\ifthenelse{\equal{\ShowQubits}{show}}{
								\fill[white] (\col, \row) circle (2.5pt);
								\fill[darkgray!25] (\col, \row) circle (2pt);
							}{}
							\ifthenelse{\equal{\ShowCoordinates}{show}}{
								\node at (\col, \row) {\tiny\bf\tt (\col,\row)};
							}{}
						};
					};
				};
			}

			{#2}
		\end{tikzpicture}
	\endgroup
}

\newcommand{\LogicalQubit}[2][]{
	\begingroup
		\tikzset{sc/logical/qubit/.cd, #1}

		\def\OrderH{\pgfkeysvalueof{/tikz/sc/logical/qubit/orderH}}
		\def\OrderW{\pgfkeysvalueof{/tikz/sc/logical/qubit/orderW}}

		\ifthenelse{\equal{\OrderH}{0}}{
			\def\OrderH{\Order}
		}{}

		\ifthenelse{\equal{\OrderW}{0}}{
			\def\OrderW{\Order}
		}{}

		\def\Offset{\pgfkeysvalueof{/tikz/sc/logical/qubit/offset}}
		\def\Position{\pgfkeysvalueof{/tikz/sc/logical/qubit/position}}
		\def\ShowStabilizersLabels{\pgfkeysvalueof{/tikz/sc/logical/qubit/stabilizers}}
		\def\Hadamard{\Offset} % Should be mod(Offset+Perimeter, 2)

		\begin{scope}[shift={(\Position)}]
			\tikzmath{
				real \Trim;
				\Trim = 1 / 128;
				integer \DistanceH, \DistanceW;
				\DistanceH = 2 * \OrderH + 1;
				\DistanceW = 2 * \OrderW + 1;
				% Place Stabilizer Plaquettes
				for \row in {0,...,\DistanceH} {
					for \col in {0,...,\DistanceW} {
						Plaquette(\DistanceH, \DistanceW, \row, \col, 0.4);
					};
				};
				% Place Data Qubits
				for \row in {1,...,\DistanceH} {
					for \col in {1,...,\DistanceW} {
						{
							\ifthenelse{\equal{\ShowQubits}{show}}{
								\fill[white] (\col, \row) circle (2.5pt);
								\fill[data] (\col,\row) circle (2pt);
							}{}
						};
					};
				};
			}
		\end{scope}
	\endgroup
}

\newcommand{\LogicalGate}[3][]{
	\begingroup
		\tikzset{sc/logical/gate/.cd, #1}

		\def\GateType{\pgfkeysvalueof{/tikz/sc/logical/gate/type}}

		\def\Source{#2}
		\def\Target{#3}

		\draw[\GateType, line width = 7pt, line cap = round] \Source -- \Target;
	\endgroup
}